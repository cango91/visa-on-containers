version: '3'
services:
  redis:
    image: 'redis'
    command:
      [
        "redis-server",
        "--maxmemory-policy",
        "allkeys-lru",
        "--maxmemory",
        "128mb"
      ]
    ports:
      - "6379:6379"
  rabbitmq:
    image: 'rabbitmq:3-management'
    command: ["bash", "/scripts/rabbit_startup.sh"]
    volumes:
      - ./rabbit_startup.sh:/scripts/rabbit_startup.sh
    ports:
      - "5672:5672" # AMQP protocol
      - "15672:15672" # Management UI
    environment:
      RABBIT_URL: amqp://rabbitmq
    secrets:
      - AUTH_RABBIT_USER
      - AUTH_RABBIT_PASSWORD
      - SMTP_RABBIT_PASSWORD
      - SMTP_RABBIT_USER
      - EMAIL_RABBIT_USER
      - EMAIL_RABBIT_PASSWORD
  auth_service:
    build: ./services/authentication
    ports:
      - "3001:3001"
    depends_on:
      - redis
      - rabbitmq
    environment:
      REDIS_URL: redis://redis:6379
      RABBIT_URL: amqp://rabbitmq
      DOCKER: 1
    secrets:
      - AUTH_SERVICE_SECRET
      - AUTH_DB_URL
      - AUTH_HASH_DIGEST
      - AUTH_HASH_ITER_ROUNDS
      - AUTH_HASH_KEY_LENGTH
      - AUTH_HASH_SALT_LENGTH
      - AUTH_RABBIT_USER
      - AUTH_RABBIT_PASSWORD
  gateway_api:
    build: ./services/gateway
    ports:
      - "3000:3000"
    depends_on:
      - redis
      - auth_service
    environment:
      REDIS_URL: redis://redis:6379
      DOCKER: 1
    secrets:
      - AUTH_SERVICE_SECRET
      - EMAIL_SERVICE_SECRET
secrets:
  SMTP_RABBIT_USER:
    file: ./secrets/smtp/SMTP_RABBIT_USER.txt
  SMTP_RABBIT_PASSWORD:
    file: ./secrets/smtp/SMTP_RABBIT_PASSWORD.txt
  SMTP_EMAIL_HOST:
    file: ./secrets/smtp/SMTP_EMAIL_HOST.txt
  SMTP_EMAIL_USER:
    file: ./secrets/smtp/SMTP_EMAIL_USER.txt
  SMTP_EMAIL_PASSWORD:
    file: ./secrets/smtp/SMTP_EMAIL_PASSWORD.txt
  SMTP_EAMIL_FROM:
    file: ./secrets/smtp/SMTP_EAMIL_FROM.txt
  AUTH_SERVICE_SECRET:
    file: ./secrets/authentication/AUTH_SERVICE_SECRET.txt
  AUTH_DB_URL:
    file: ./secrets/authentication/AUTH_DB_URL.txt
  AUTH_HASH_ITER_ROUNDS:
    file: ./secrets/authentication/AUTH_HASH_ITER_ROUNDS.txt
  AUTH_HASH_SALT_LENGTH:
    file: ./secrets/authentication/AUTH_HASH_SALT_LENGTH.txt
  AUTH_HASH_DIGEST:
    file: ./secrets/authentication/AUTH_HASH_DIGEST.txt
  AUTH_HASH_KEY_LENGTH:
    file: ./secrets/authentication/AUTH_HASH_KEY_LENGTH.txt
  AUTH_RABBIT_USER:
    file: ./secrets/authentication/AUTH_RABBIT_USER.txt
  AUTH_RABBIT_PASSWORD:
    file: ./secrets/authentication/AUTH_RABBIT_PASSWORD.txt
  EMAIL_SERVICE_SECRET:
    file: ./secrets/email/EMAIL_SERVICE_SECRET.txt
  EMAIL_DB_URL:
    file: ./secrets/email/EMAIL_DB_URL.txt
  EMAIL_RABBIT_USER:
    file: ./secrets/email/EMAIL_RABBIT_USER.txt
  EMAIL_RABBIT_PASSWORD:
    file: ./secrets/email/EMAIL_RABBIT_PASSWORD.txt
